#!/bin/sh
# Pre-commit hook to detect secrets and prevent them from being committed

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "${YELLOW}üîç Running pre-commit secret detection...${NC}"

# Check for common secret patterns in staged files
STAGED_FILES=$(git diff --cached --name-only)

# Pattern to match JWT tokens, API keys, Bearer tokens, etc.
SECRET_PATTERNS=(
  "Bearer\s+eyJ[a-zA-Z0-9_\-]*\.[a-zA-Z0-9_\-]*\.[a-zA-Z0-9_\-]*"  # JWT tokens
  "Authorization.*Bearer\s+[a-zA-Z0-9_\-]*"                         # Bearer tokens
  "apikey\s*[:=]\s*['\"]?[a-zA-Z0-9]{20,}"                          # API keys
  "(aws_access_key_id|aws_secret_access_key)\s*[:=]"                # AWS keys
  "private_key.*:.*['\"]-----BEGIN"                                  # Private keys
)

FOUND_SECRETS=0

for file in $STAGED_FILES; do
  # Skip binary files
  if file "$file" | grep -q "binary"; then
    continue
  fi

  # Check if file exists (it might be deleted)
  if [ ! -f "$file" ]; then
    continue
  fi

  # Skip certain directories and files
  if echo "$file" | grep -E "(node_modules|coverage|dist|build|\.next|\.husky)" > /dev/null; then
    continue
  fi

  # Check for suspicious patterns
  if grep -qiE "Bearer\s+eyJ[a-zA-Z0-9_\.\-]{100,}" "$file" 2>/dev/null; then
    echo -e "${RED}‚ùå Possible JWT token found in: $file${NC}"
    FOUND_SECRETS=1
  fi

  if grep -qiE "(apiKey|api_key|API_KEY|secret|SECRET)\s*[:=].*['\"][a-zA-Z0-9]{20,}" "$file" 2>/dev/null; then
    echo -e "${RED}‚ùå Possible API key found in: $file${NC}"
    FOUND_SECRETS=1
  fi

  if grep -qiE "Authorization.*Bearer\s+[a-zA-Z0-9_\-\.]+" "$file" 2>/dev/null; then
    echo -e "${RED}‚ùå Possible authorization token found in: $file${NC}"
    FOUND_SECRETS=1
  fi
done

if [ $FOUND_SECRETS -eq 1 ]; then
  echo ""
  echo -e "${RED}‚ö†Ô∏è  SECURITY CHECK FAILED${NC}"
  echo "Secrets detected in staged files!"
  echo "Please remove them before committing."
  echo ""
  echo "If these are legitimate development files, add them to .gitignore"
  exit 1
fi

echo -e "${GREEN}‚úì No secrets detected. Safe to commit!${NC}"
exit 0
